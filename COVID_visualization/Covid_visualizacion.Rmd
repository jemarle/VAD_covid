---
title: "Proyecto Visualizacion Covid"
author: "dfa Vicente Martínez"
date: "2024-02-14"
output: html_document
---

```{r}
library(ggmap)
# library(rgdal)
library(dplyr)
library(tidyr)
library(tmap)
library(geospatial)
library(maps)
library(raster)
library(tmaptools)
library(leaflet)
library(geojsonio)
library(leaflet)
library(ggplot2)
library(shiny)
```

```{r}
#covid_hospitalizations_raw <- read.csv("./data/owid-covid-data.csv")
covid_hospitalizations_raw <- read.csv("./data/covid-hospitalizations.csv")
locations <- read.csv("./data/locations.csv")
data("World")
```

```{r}
# Load necessary libraries
library(shiny)
library(shinydashboard)

initial_value <- "Daily ICU occupancy"
#initial_value <- "icu_patients"
# Round a number to the nearest multiple of 10000
round_to_100 <- function(x) {
  100 * ceiling(x / 100)
}

my_palette <- colorRampPalette(c("lightyellow", "darkgreen"))(6)
filtered_legend <- covid_hospitalizations_raw %>%
      dplyr::filter(indicator == initial_value)

# UI code
ui <- dashboardPage(
  dashboardHeader(title = "COVID-19 App"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Inicio", tabName = "home", icon = icon("home")),
      menuItem("Visualización de indicadores", tabName = "page1", icon = icon("stats", lib = "glyphicon")),
      menuItem("I+D COVID-19", tabName = "page2", icon = icon("info"))
    )
  ),
  dashboardBody(
    tabItems(
      # Home page
      tabItem(tabName = "home",
              fluidRow(
                box(title = h2("Infromación sobre el COVID-19"),
                    width = 12)
              ),
              fluidPage(
                htmlOutput("informacion_covid"))
              
      ),
      # Page 1 content
      tabItem(tabName = "page1",
              fluidRow(
              column(width = 4,
                selectInput("indicator_selector", "Selecciona el indicador a representar:",
                       choices = unique(covid_hospitalizations_raw$indicator))),
              column(width = 4,
                uiOutput("date_slider_ui")),
              column(width = 4,
                selectInput("continent", "Selecciona un continente:",
                  choices = c("Africa", "Asia", "Europe", "North America", "Oceania", "South America")))
              ),
                tmapOutput("my_tmap"),
 
              fluidRow(
              box(column(width = 12,
                plotOutput("selected_country_plot")), width = 12))
              
              ),
      # Page 2 content
      tabItem(tabName = "page2",
        fluidPage(
          titlePanel("Descubrimientos y Avances en la Lucha contra el COVID-19"),
          
          fluidRow(
            column(6,
                   wellPanel(
                      tags$a(href = "https://www.nationalgeographic.com.es/ciencia/asi-funcionan-vacunas-arn-mensajero_16221", 
                             tags$img(src = "https://th.bing.com/th/id/OIP.Y3AB96afVEf95vosovQ8IwAAAA?rs=1&pid=ImgDetMain", width = "100%"),
                     p(h5("El desarrollo de la vacuna mRNA ha sido un avance crucial en la lucha contra el COVID-19. Esta tecnología ha demostrado ser segura y efectiva en la prevención de la enfermedad."))
                   ))
            ),
            
            column(6,
                   wellPanel(
                     tags$a(href ="https://www.factcheck.org/es/2021/03/scicheck-nuevos-hallazgos-cientificos-sobre-uso-de-mascarillas-y-covid-19/" , 
                           tags$img(src = "https://th.bing.com/th/id/OIP.PZhLcBePCCgdPNne-gRfbQHaEK?rs=1&pid=ImgDetMain", width = "100%"),
                     p(h5("Los estudios han demostrado que el uso de mascarillas puede reducir significativamente la transmisión del virus. Esto ha llevado a una mayor aceptación y uso de mascarillas en la comunidad."))
                   ))
            )
          ),
          
          fluidRow(
            column(6,
                   wellPanel(
                     tags$a(href = "https://covidblog.oregon.gov/tratamiento-con-anticuerpos-monoclonales-para-covid-19/#:~:text=La%20evidencia%20preliminar%20sugiere%20que%20los%20mAb%20administrados,la%20hospitalizaci%C3%B3n%20y%20evitar%20que%20la%20enfermedad%20progrese.", 
                           tags$img(src = "https://gacetamedica.com/wp-content/uploads/2021/11/GettyImages-1297158114.jpg", width = "100%"),
                     p(h5("Los tratamientos con anticuerpos monoclonales han mostrado ser eficaces en pacientes con COVID-19 grave. Estos tratamientos pueden ayudar a reducir la gravedad de la enfermedad y la necesidad de hospitalización."))
                   ))
            ),
            
            column(6,
                   wellPanel(
                     tags$a(href="https://www.isciii.es/InformacionCiudadanos/DivulgacionCulturaCientifica/DivulgacionISCIII/Paginas/Divulgacion/InformeCoronavirusSecuenciacion.aspx#:~:text=La%20secuenciaci%C3%B3n%20gen%C3%B3mica%20del%20SARS-CoV-2%20ha%20permitido%20averiguar,para%20el%20futuro%20desarrollo%20de%20f%C3%A1rmacos%20y%20vacunas.",
                          tags$img(src = "https://th.bing.com/th/id/OIP.yxngBx-ii6jMOUq9xMly-gHaEK?rs=1&pid=ImgDetMain", width = "100%"),
                     p(h5("Los avances en la secuenciación genómica han permitido un seguimiento más preciso de las variantes del virus. Esto es crucial para entender cómo evoluciona el virus y desarrollar estrategias de prevención y tratamiento adecuadas."))
                   ))
            )
          )
        )
      )
    )
  )
)

# Server code (not necessary for this example)
server <- function(input, output, session) {output$informacion_covid <- renderUI({
    HTML("
      <p>El COVID-19 es una enfermedad causada por el coronavirus SARS-CoV-2. Desde su aparición en diciembre de 2019, ha tenido un impacto significativo a nivel mundial.</p>

      <h2>Síntomas</h2>

      <p>Los síntomas comunes del COVID-19 incluyen:</p>

      <ol>
        <li>Fiebre</li>
        <li>Tos seca</li>
        <li>Fatiga</li>
        <li>Dificultad para respirar</li>
      </ol>

      <h2>Transmisión</h2>

      <p>El virus se transmite principalmente a través de:</p>

      <ul>
        <li>Gotículas respiratorias cuando una persona infectada tose, estornuda o habla.</li>
        <li>Contacto cercano con una persona infectada.</li>
        <li>Superficies contaminadas.</li>
      </ul>

      <h2>Prevención</h2>

      <p>Para prevenir la propagación del COVID-19, se recomienda:</p>

      <ul>
        <li>Lavarse las manos con frecuencia con agua y jabón.</li>
        <li>Usar mascarillas en lugares públicos.</li>
        <li>Mantener la distancia física con otras personas.</li>
        <li>Evitar tocarse la cara con las manos sin lavar.</li>
        <li>Ventilar los espacios cerrados.</li>
      </ul>

      <h2>Vacunación</h2>

      <p>La vacunación es una herramienta clave en la lucha contra el COVID-19. Las vacunas autorizadas han demostrado ser seguras y efectivas para prevenir la enfermedad grave y reducir la transmisión.</p>

      <h1>Conclusiones</h1>

      <p>El COVID-19 continúa siendo un desafío global, pero con medidas preventivas adecuadas y la vacunación masiva, podemos controlar su propagación y proteger a nuestras comunidades.</p>
    ")
})

observe({
    # Filter available dates based on selected indicator
    selected_indicator <- input$indicator_selector
    
  })
  
  output$date_slider_ui <- renderUI({
    sliderInput("date_slider", label = "Selecciona la fecha:",
                min = as.Date("2021-01-01"),
                max = as.Date("2022-01-01"),
                value = as.Date("2021-01-01"),
                step = 1, animate = 
                            animationOptions(
                              interval = 2000,
                              loop = FALSE,
                              playButton = NULL,
                              pauseButton = NULL)
    
)
  })
  
  observeEvent(input$continent, {
    # Define coordinates for each continent
    continent_coords <- list(
      Africa = c(0, 20),
      Asia = c(35, 100),
      Europe = c(50, 10),
      "North America" = c(40, -100),
      Oceania = c(-25, 135),
      "South America" = c(-10, -60)
    )
    
    # Get selected continent coordinates
    coords <- continent_coords[[input$continent]]
    
    # Update map view to zoom to the selected continent
    leafletProxy("my_tmap") %>%
      setView(lng = coords[2], lat = coords[1], zoom = 3)
  })
  
  output$my_tmap <- renderTmap({
    data("World")
    tm_shape(World, projection = "+proj=robin") +
      tm_borders(zindex = 666)
  })
  
  observeEvent(c(input$indicator_selector, input$date_slider), {
    req(input$indicator_selector, input$date_slider)
    # Filter data based on selected indicator and date
    selected_indicator <- input$indicator_selector
    selected_date <- input$date_slider
    
    filtered_data <- covid_hospitalizations_raw %>%
      filter(indicator == selected_indicator & date == selected_date)
    
    filtered_legend <- covid_hospitalizations_raw %>%
      filter(indicator == selected_indicator)
    legend_breaks <- seq(min(filtered_legend$value), round_to_100(max(filtered_legend$value)), length.out = 6)
    
    # Join with world data
    World_dataset <- inner_join(World, filtered_data, by = c("name" = "entity"))
    
    # Create map
    tmapProxy("my_tmap", session, {
      tm_remove_layer(666) +
        tm_shape(World_dataset, projection = "+proj=robin") + 
          tm_polygons("value", legend.title = selected_indicator, palette = my_palette, breaks = legend_breaks, zindex = 666) + 
          tm_style("cobalt")
    })
  })
  
  output$selected_country_plot <- renderPlot({
    req(input$my_tmap_shape_click)
    
    # Get clicked country
    clicked_country <- input$my_tmap_shape_click$id
    
    # Filter data for the selected country
    selected_indicator <- input$indicator_selector
    
    selected_country_data <- covid_hospitalizations_raw %>%
      filter(iso_code == clicked_country & indicator == selected_indicator)
    selected_country_data$date <- as.Date(selected_country_data$date)
    
    # Plot time series
    ggplot(selected_country_data, aes(x = date, y = value)) +
      geom_line() + 
      labs(title = paste("Serie temporal de", clicked_country),
            x = "Fecha", y = selected_indicator) +
      scale_x_date(date_breaks = "1 month", date_labels = "%Y-%m-%d") +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })


}

# Run the application
shinyApp(ui, server)

```

```{r}
round_to_10000 <- function(x) {
  10000 * ceiling(x / 10000)
}

round_to_10000(13000)
```

